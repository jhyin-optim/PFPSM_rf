% Solve the exchange probelm:
%
%   Minimize    f_1(x_1)+ ... + f_N(x_N)
%   subject to  x_1 + ... + X_N = 0
%
% where f_i(x_i)=0.5*||C_i*x_i-d_i||^2+xi*||x_i||_1.
%------------------------------------------------------------------
% PPSM with proximal terms 0.5*||x_i-x_i^k||_{s_i*I_n-rho C_i'*C_i}^2
% added to x_i-subproblems
% Reference: Han, D.R., He, H.J., Xu, L.L.: A proximal parallel splitting method for minimizing sum of
% convex functions with linear constraints. J Comput. Appl. Math. 256, 36-51 (2014)
%------------------------------------------------------------------
function [X,lambda,Out] = ExchgQuad_PPSM(C,d,CtC,Ctd,s,opts)
% Get parameters
rho = opts.rho;      % penalty parameter
gamma = opts.gamma;  % steplength coefficient
maxit = opts.maxit;  % max number of iterations
tol = opts.tol;      % tolerance
xi = opts.xi;        % model parameter
n = size(C{1},2);    % length of x_i
N = length(C);       % number of x_i's

% Start clock
t0 = tic;

% Initialization
X = zeros(n,N);
sumX = zeros(n,1);   % sum of x_i's
barX = X;
lambda = zeros(n,1);

% define function handle for computing the projection
Proj = @(u,x) x-max(-u,min(x,u));

% Objective values
Out.objValue = zeros(maxit,1);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  zeros(maxit,1);
% Residuals
Out.residual = zeros(maxit,1);

% Main iteration
for iter = 1:maxit
    % Store solution at previous iteration
    Xp = X;
    
    % Predictor: barX, barlambda (output of PPSM)
    for j = 1:N
        zjk = rho+s{j}*ones(n,1);
        muj = xi./zjk;
        wjk = (Ctd{j}+lambda-rho*sumX-CtC{j}*X(:,j))./zjk+X(:,j);
        barX(:,j) = Proj(muj,wjk);
    end
    
    % Sum of x_j (residual)
    sumbarX = sum(barX,2);
    % Update dual variable
    barlambda = lambda - rho*sumbarX;
    
    % Compute correction stepsize
    sumnorm = 0;
    for j=1:N
        sumnorm = sumnorm+(barX(:,j)-X(:,j))'*((rho+s{j})*eye(n)-CtC{j})*(barX(:,j)-X(:,j));
    end
    varphi = sumnorm+rho*norm(sumX)^2;
    phi = sumnorm+rho*norm(sumbarX)^2+N*rho*norm(barX-X,'fro')^2;
    alphak = gamma*varphi/phi;
    
    % Correction step
    X = (1-alphak)*X+alphak*barX;
    lambda = (1-alphak)*lambda+alphak*barlambda;
    sumX = sum(X,2);
    
    Out.objValue(iter) = ObjVal(X);
    Out.residual(iter) = norm(sumX);
    
    % Stopping criterion
    if norm(X-Xp,'fro') < tol*norm(X,'fro')
        break
    end

end
Out.CPUtime = toc(t0);
Out.iter = iter;
Out.objValue = Out.objValue(1:iter);
Out.residual = Out.residual(1:iter);

% Nested function: compute objective value
    function obj = ObjVal(X)
        obj = 0;
        for jj = 1:N
            obj = obj+0.5*sum((C{jj}*X(:,jj)-d{jj}).^2)+xi*norm(X(:,jj),1);
        end
    end  
end
